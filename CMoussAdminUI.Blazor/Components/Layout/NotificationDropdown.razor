@using CMoussAdminUI.Services
@using CMoussAdminUI.Models
@using CMouss.IdentityFramework.BlazorUI
@inject INotificationService NotificationService
@inject NavigationManager NavigationManager
@implements IDisposable

<div class="dropdown">
    <button class="btn btn-link position-relative p-2" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-bell fs-5"></i>
        @if (UnreadCount > 0)
        {
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                @UnreadCount
                <span class="visually-hidden">unread notifications</span>
            </span>
        }
    </button>
    <div class="dropdown-menu dropdown-menu-end notification-dropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
        <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
            <h6 class="mb-0">Notifications</h6>
            @if (Notifications.Any(n => !n.IsRead))
            {
                <button class="btn btn-sm p-0 text-decoration-none" @onclick="MarkAllAsRead">
                    Mark All as Read
                </button>
            }
        </div>

        @if (!Notifications.Any())
        {
            <div class="text-center py-4 text-muted">
                <i class="bi bi-bell-slash fs-1 d-block mb-2"></i>
                <p class="mb-0">No notifications</p>
            </div>
        }
        else
        {
            @foreach (var notification in Notifications)
            {
                <div class="notification-item dropdown-item @(!notification.IsRead ? "unread" : "read")" style="@(notification.IsRead ? "background-color: rgba(0,0,0,0.08); opacity: 0.75;" : "")" @onclick="() => HandleNotificationClick(notification)">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            @if (!string.IsNullOrEmpty(notification.Icon))
                            {
                                <i class="bi bi-@notification.Icon fs-4 @GetNotificationTypeClass(notification.Type)"></i>
                            }
                            else
                            {
                                <i class="bi @GetDefaultIcon(notification.Type) fs-4 @GetNotificationTypeClass(notification.Type)"></i>
                            }
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-1 fw-semibold">@notification.Title</h6>
                                @if (!notification.IsRead)
                                {
                                    <span class="badge bg-primary rounded-circle p-1" style="width: 8px; height: 8px;"></span>
                                }
                            </div>
                            <p class="mb-1 small text-muted">@notification.Message</p>
                            <small class="text-muted">@GetTimeAgo(notification.CreatedAt)</small>
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm p-0 text-danger" @onclick:stopPropagation="true" @onclick="() => RemoveNotification(notification.Id)">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                </div>
            }

            @if (Notifications.Any())
            {
                <div class="border-top p-2 text-center">
                    <button class="btn btn-link btn-sm text-decoration-none" @onclick="ClearAll">
                        Clear all notifications
                    </button>
                </div>
            }
        }
    </div>
</div>

@code {
    [CascadingParameter]
    public AuthLayoutModel? AuthLayoutModel { get; set; }

    private List<Notification> Notifications { get; set; } = new();
    private int UnreadCount { get; set; }

    private string CurrentUserId => AuthLayoutModel?.User?.Id ?? string.Empty;

    protected override void OnInitialized()
    {
        LoadNotifications();
        NotificationService.OnNotificationsChanged += OnNotificationsChanged;
    }

    private void LoadNotifications()
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            Notifications = NotificationService.GetNotifications(CurrentUserId).ToList();
            UnreadCount = NotificationService.GetUnreadCount(CurrentUserId);
        }
        else
        {
            Notifications = new List<Notification>();
            UnreadCount = 0;
        }
    }

    private async void OnNotificationsChanged(string userId)
    {
        if (userId == CurrentUserId)
        {
            LoadNotifications();
            await InvokeAsync(StateHasChanged);
        }
    }

    private void HandleNotificationClick(Notification notification)
    {
        if (!notification.IsRead && !string.IsNullOrEmpty(CurrentUserId))
        {
            NotificationService.MarkAsRead(CurrentUserId, notification.Id);
        }

        if (!string.IsNullOrEmpty(notification.ActionUrl))
        {
            NavigationManager.NavigateTo(notification.ActionUrl);
        }
    }

    private void MarkAllAsRead()
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            NotificationService.MarkAllAsRead(CurrentUserId);
        }
    }

    private void RemoveNotification(string notificationId)
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            NotificationService.RemoveNotification(CurrentUserId, notificationId);
        }
    }

    private void ClearAll()
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            NotificationService.ClearAll(CurrentUserId);
        }
    }

    private string GetNotificationTypeClass(NotificationType type)
    {
        return type switch
        {
            NotificationType.Success => "text-success",
            NotificationType.Warning => "text-warning",
            NotificationType.Error => "text-danger",
            _ => "text-info"
        };
    }

    private string GetDefaultIcon(NotificationType type)
    {
        return type switch
        {
            NotificationType.Success => "bi-check-circle",
            NotificationType.Warning => "bi-exclamation-triangle",
            NotificationType.Error => "bi-x-circle",
            _ => "bi-info-circle"
        };
    }

    private string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.UtcNow - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "Just now";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes}m ago";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours}h ago";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays}d ago";

        return dateTime.ToString("MMM dd");
    }

    public void Dispose()
    {
        NotificationService.OnNotificationsChanged -= OnNotificationsChanged;
    }
}
